<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸŒ± G.R.O.W.T.H. Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Poppins", sans-serif; margin: 0; padding: 20px; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; width: 100%; max-width: 1000px; margin-top: 20px; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .val { font-size: 2em; font-weight: 600; color: #2ecc71; display: block; }
        .label { font-size: 0.9em; color: #888; text-transform: uppercase; }
        .chart-container { width: 100%; max-width: 500px; margin-top: 30px; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 20px; }
        button { background: #27ae60; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; width: 100%; max-width: 400px; }
        #status { font-size: 0.8em; margin-bottom: 10px; color: #00d4ff; }
    </style>
</head>
<body>

    <h1>ðŸŒ± Smart Planter Live</h1>
    <div id="status">Syncing with Firebase...</div>

    <div class="grid">
        <div class="card"><span class="label">Temperature</span><span id="t" class="val">--</span></div>
        <div class="card"><span class="label">Moisture</span><span id="m" class="val">--</span></div>
        <div class="card"><span class="label">Soil pH</span><span id="p" class="val">--</span></div>
        <div class="card"><span class="label">Light (Lux)</span><span id="l" class="val">--</span></div>
    </div>

    <div class="chart-container">
        <canvas id="npkChart"></canvas>
    </div>

    <button id="dl">ðŸ“¥ Download CSV Log</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const conf = {
    databaseURL: "https://tanim-ashs-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tanim-ashs"
};

const app = initializeApp(conf);
const db = getDatabase(app);
const rRef = ref(db, "readings");

// Chart Setup
const ctx = document.getElementById('npkChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Nitrogen', 'Phosphorus', 'Potassium'],
        datasets: [{ label: 'Soil Nutrients', data: [0, 0, 0], backgroundColor: ['#ff5f6d', '#ffc371', '#2193b0'] }]
    },
    options: { scales: { y: { beginAtZero: true, grid: { color: '#333' } } }, plugins: { legend: { display: false } } }
});

// REAL-TIME DATA LOGIC
onValue(rRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.val();
    
    // Get all entry keys and find the latest one
    const keys = Object.keys(data);
    const latest = data[keys[keys.length - 1]];

    // Update Text
    document.getElementById('t').innerText = latest.Temp + "Â°C";
    document.getElementById('m').innerText = latest.Moisture + "%";
    document.getElementById('p').innerText = latest.PH;
    document.getElementById('l').innerText = latest.Lux;
    document.getElementById('status').innerText = "Last Update: " + new Date(latest.timestamp).toLocaleTimeString();

    // Update Chart
    chart.data.datasets[0].data = [latest.N, latest.P, latest.K];
    chart.update();
});

// DOWNLOAD LOGIC
document.getElementById('dl').onclick = async () => {
    const snap = await get(rRef);
    if (!snap.exists()) return;
    
    const data = snap.val();
    const headers = "Timestamp,Temp,Moisture,PH,Lux,N,P,K,Mode,Pump,Fert\n";
    
    // Convert object to rows
    let rows = "";
    Object.values(data).forEach(r => {
        const time = new Date(r.timestamp).toLocaleString().replace(/,/g, "");
        rows += `${time},${r.Temp},${r.Moisture},${r.PH},${r.Lux},${r.N},${r.P},${r.K},${r.Mode},${r.Pump},${r.Fert}\n`;
    });

    const blob = new Blob([headers + rows], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "planter_data.csv";
    a.click();
};
</script>
</body>
</html>
